name: Axiom Coverage Validation

on:
  workflow_dispatch:
    inputs:
      file:
        description: "Only test axioms in this file (e.g. 'Equiv.lean'). Leave blank for all."
        required: false
        default: ""
      axiom:
        description: "Only test a single axiom by name (e.g. 'and_self'). Leave blank for all."
        required: false
        default: ""

permissions:
  contents: read

jobs:
  axiom-coverage:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          persist-credentials: false

      - name: Install elan
        run: |
          curl -sSfL https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh | sh -s -- -y --default-toolchain none
          echo "$HOME/.elan/bin" >> $GITHUB_PATH

      - name: Cache Lake packages
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: |
            ~/.elan/toolchains
            .lake
          key: ${{ runner.os }}-lake-${{ hashFiles('lakefile.toml', 'lean-toolchain') }}
          restore-keys: |
            ${{ runner.os }}-lake-

      - name: Run runtime coverage analysis (static)
        run: python3 tools/axiom_coverage_validator.py --runtime --report tools/axiom_runtime_coverage_report.json

      - name: Build baseline
        run: lake build sql_equiv_test

      - name: Run axiom coverage validator
        env:
          INPUT_FILE: ${{ inputs.file }}
          INPUT_AXIOM: ${{ inputs.axiom }}
        run: |
          args=(--ci)
          if [ -n "$INPUT_FILE" ]; then
            args+=(--file "$INPUT_FILE")
          fi
          if [ -n "$INPUT_AXIOM" ]; then
            args+=(--axiom "$INPUT_AXIOM")
          fi
          python3 tools/axiom_coverage_validator.py "${args[@]}"

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: axiom-coverage-report
          path: |
            tools/axiom_coverage_report.json
            tools/axiom_coverage_checkpoint.json
            tools/axiom_runtime_coverage_report.json
